===============
SAC Data Access
===============


.. ############################################################################ ..
.. #                         PYTHON OBJECT FOR SAC FILE                       # ..
.. ############################################################################ ..

Python Object for SAC File
--------------------------

The ``pysmo.sac`` package is developed to read and write individual SAC files.
The Python class ``sacfile`` of module ``sacio`` opens a SAC file and returns an object including data and all SAC header variables as its attributes. Modifications of object attributes are saved to file. It is written purely in Python so that it also runs with `Jython <http://www.jython.org>`_.
  	
`egsac.py`
~~~~~~~~~~

The ``<pkg-install-dir>/aimbat/scripts/egsac.py`` script gives a simple example to read, resample and plot a seismogram using pysmo, Scipy and Matplotlib. You can type the codes in a Python/iPython shell, or run as a script in the data example directory ``<pkg-install-dir>/data-example/example_pkl_files/Event_2011.09.15.19.31.04.080``, hereafter refered to as `<example-event-dir>`.

.. image:: SACdataAccess/prog-egsac.png

Resampling Seismograms
~~~~~~~~~~~~~~~~~~~~~~

In this example, a SAC file named ``TA.109C.\_\_.BHZ.sac`` is read in as a sacfile object. The time array is calculated from SAC headers.  The data array is resampled from interval 0.025 to 2.0 seconds using Scipy's signalprocessing module.

Add the following codes to write the resampled seismogram to file ``TA.109C.\_\_.BHZ.sac``::

	sacobj.delta = deltanew
	sacobj.npts = nptsnew
	sacobj.data = y2

.. image:: SACdataAccess/egsac-109c.png

.. ############################################################################ ..
.. #                         PYTHON OBJECT FOR SAC FILE                       # ..
.. ############################################################################ ..










.. ############################################################################ ..
.. #                        PYTHON PICKLE FOR SAC FILES                       # ..
.. ############################################################################ ..

Python Pickle for SAC Files
---------------------------

The \texttt{pysmo.sacio} module converts SAC files to ``sacfile`` objects. Any modification of the objects are instantly written to files. In data processing, the user may want to abandon changes made earlier, which brings the need of a buffer for the ``sacfile`` objects.

The ``SacDataHdrs`` class in the ``pysmo.aimbat.sacpickle`` module is written on top of ``pysmo.sacio`` to serves this purpose by reading a SAC file and returning a \texttt{sacdh} object that is very similar of the ``sacfile`` object. Essentially, the ``sacdh`` object is a copy of the the \texttt{sacfile} object in the memory, except that SAC headers 't0-t9', 'user0-user9', 'kuser0-kuser2' are saved in three Python lists.

A ``gsac`` object of the ``SacGroup`` class consists of a group of ``sacdh`` objects from event-based SAC data files, earthquake hypocenter information and station locations.
An additional step is required to save changes in the ``gsac`` object to files.

In order to avoid frequent SAC file I/O, the ``pickle/cPickle`` module is used for serializing and de-serializing the ``gsac`` object structure. Thus the data processing efficiency is improved because reading and writing of SAC files are done only once each before and after data processing. Script ``sac2pkl.py`` does the conversions between SAC files and Python pickles. 

Its usage message can be printed out by running at command line::

	sac2pkl.py -h

and the result is displayed in the figure below. For example, in the data example directory ``<example-event-dir>``, run::

	sac2pkl.py -s *Z -o 20110915.19310408.bhz.pkl -d 0.025

to read 163 vertical component seismograms at a sample interval of 0.025 s and convert to a ``gsac`` object which is saved in the pickle file ``20110915.19310408.bhz.pkl``.

To save disk space, compressed pickle files in ``gz`` and ``bz2`` formats can be generated by::

	sac2pkl.py -s *Z -o 20110915.19310408.bhz.pkl -d 0.025 -z gz
	sac2pkl.py -s *Z -o 20110915.19310408.bhz.pkl -d 0.025 -z bz2

at the cost of more CPU time.

After processing, run::

	sac2pkl.py 20110915.19310408.bhz.pkl -p

to convert the pickle file to SAC files.

..image:: SACdataAccess/help-sac2pkl

See the doc string of ``pysmo.aimbat.sacpickle`` by typing in a python console::

	from pysmo.aimbat import sacpickle
	print sacpickle.\_\_doc\_\_
 
and also the documentation on `pickle <http://docs.python.org/library/pickle.html>`_ for more information about the Python data structure, pickling and unpickling.


.. ############################################################################ ..
.. #                        PYTHON PICKLE FOR SAC FILES                       # ..
.. ############################################################################ ..




















